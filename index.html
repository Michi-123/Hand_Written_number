<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hand written recognition (Mobile Tabs)</title>
<style>
  :root{
    --pad: 10px;
    --gap: 12px;
    --radius: 10px;
    --bg: #0b0b0c;
    --panel:#1a1b1e;
    --line:#2a2b30;
    --text:#eaeef3;
    --muted:#a7b0bd;
    --accent:#5bbcff;
    --ok:#00cc00;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;}
  *{box-sizing:border-box}

  /* ===== Top Tabs ===== */
  .tabs{position:sticky;top:0;z-index:5;background:linear-gradient(180deg, rgba(0,0,0,.65), rgba(0,0,0,0));padding:var(--pad) var(--pad) 0}
  .tabbar{display:flex;gap:8px;}
  .tabbar button{flex:1;appearance:none;border:1px solid var(--line);background:var(--panel);color:var(--text);padding:10px 12px;border-radius:999px;font-weight:600}
  .tabbar button[aria-selected="true"]{outline:2px solid var(--accent);}

  main{padding:var(--pad);}

  /* ===== Canvas & Controls ===== */
  .workspace{display:grid;grid-template-columns:1fr;gap:var(--gap);}
  @media (min-width: 900px){
    .workspace{grid-template-columns: 320px 1fr;align-items:start}
  }

  .panel{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:var(--pad)}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  label.inline{font-size:14px;color:var(--muted)}
  input[type="number"], input[type="text"], input[type="range"], select{background:#0e0f12;color:var(--text);border:1px solid var(--line);border-radius:8px;padding:6px 8px}
  input[type="range"]{width:180px}
  .btn{appearance:none;border:1px solid var(--line);background:#141519;color:var(--text);padding:8px 12px;border-radius:10px;font-weight:600}
  .btn.ok{border-color:#0d3;}

  /* Canvas */
  #canvas{background:#fff;border:1px solid #aaa;border-radius:8px;touch-action:none;display:block;width:min(92vw, 360px);height:min(92vw, 360px)}

  /* Classes table (horizontal like table1) */
  .classes-wrap{overflow:auto}
  table#classes_data, table#classes_pred{width:100%;border-collapse:collapse}
  table#classes_data td, table#classes_pred td, table#classes_data th, table#classes_pred th{border-bottom:1px solid var(--line);padding:8px}
  table#classes_data tr:hover, table#classes_pred tr:hover{background:#13161c}
  td.cell{width:42px;text-align:center;font-weight:700}
  td.graph{min-width:160px}
  .bar{height:12px;background:var(--ok);border-radius:6px}
  td.indicator{color:#f99;white-space:nowrap}

  /* Result area */
  #predicted{background:#fff;color:#222;width:120px;height:120px;text-align:center;font-size:80px;border:1px solid #ccc;border-radius:8px;display:flex;align-items:center;justify-content:center}
  #hypothesis{min-height:24px;color:var(--muted)}
</style>
</head>
<body>

<div class="tabs" role="tablist" aria-label="handwrite tabs">
  <div class="tabbar">
    <button id="tab-data" role="tab" aria-controls="panel-data" aria-selected="true">データ作成</button>
    <button id="tab-train" role="tab" aria-controls="panel-train" aria-selected="false">学習</button>
    <button id="tab-infer" role="tab" aria-controls="panel-infer" aria-selected="false">推論</button>
  </div>
</div>

<main>
  <div class="workspace">
    <!-- Left: Canvas -->
    <section class="panel">
      <h3 style="margin-top:0">手書き入力7</h3>
      <canvas id="canvas" width="280" height="280"></canvas>
      
    </section>

    <!-- Right: Tabs content -->
    <section>
      <!-- データ作成 / 学習 / 推論 の各パネル -->
      <div id="panel-data" class="panel" role="tabpanel" aria-labelledby="tab-data">
        <h3 style="margin-top:0">データ作成</h3>
        <div class="row">
          <label class="inline">線色</label>
          <input type="color" id="pen_color" value="#ff7777"/>
          <input type="color" id="color" value="#ff7777" style="display:none"/>
          <button class="btn clear_canvas">Clear</button>
          <button class="btn" id="add_btn">Add</button>
        </div>
        <div class="row" style="margin-top:8px">
          <label class="inline">種別</label>
          <select id="predict_type">
            <option value="0">数字</option>
            <option value="1">アルファベット</option>
            <option value="2">かな</option>
            <option value="3">記号</option>
          </select>
        </div>

        <div class="row">
          <button class="btn" id="clear_batch">Clr Bat</button>
        </div>
        <div class="classes-wrap" style="margin-top:8px">
          <table id="classes_data"><!-- JSで行を生成 --></table>
        </div>
      </div>

      <div id="panel-train" class="panel" role="tabpanel" hidden aria-labelledby="tab-train">
        <h3 style="margin-top:0">学習</h3>
        <div class="row">
          <label class="inline">学習率</label>
          <input id="learning_rate" value="0.1" style="width:80px;text-align:right">
          <input type="range" id="learning_rate_range" min="0" max="5">
          <label class="inline">エポック</label>
          <input id="epoch" value="1" style="width:60px;text-align:right">
          <button class="btn" id="init_weights">Init</button>
          <button class="btn ok" id="train_btn">Train</button>
        </div>
        <div class="row" style="margin-top:8px">
          <label class="inline">損失:</label>
          <span id="loss"></span>
        </div>
      </div>

      <div id="panel-infer" class="panel" role="tabpanel" hidden aria-labelledby="tab-infer">
        <h3 style="margin-top:0">推論</h3>
        <div class="row">
          <button class="btn ok" id="predict">Predict</button>
          <button class="btn clear_canvas">Clear</button>
        </div>
        <div class="row" style="margin-top:12px">
          <div>
            <div style="font-size:12px;color:var(--muted);margin-bottom:6px">予測結果</div>
            <div id="predicted">&nbsp;</div>
          </div>
          <div style="margin-left:18px;min-width:200px">
            <div style="font-size:12px;color:var(--muted);margin-bottom:6px">強さ</div>
            <div id="hypothesis" style="display:none"></div>
            <div class="classes-wrap" style="margin-top:8px">
              <table id="classes_pred"><!-- JSで行を生成 --></table>
            </div>
        </div>
      </div>
    </section>
  </div>
</main>

<!-- ====== Scripts (original assets) ====== -->
<script src="jquery.js"></script>
<script src="data/cW1.js"></script>
<script src="data/cW2.js"></script>
<script src="data/cb1.js"></script>
<script src="data/cb2.js"></script>
<script src="data/W1.js"></script>
<script src="data/b1.js"></script>
<script src="data/W2.js"></script>
<script src="data/b2.js"></script>
<script src="network.js"></script>
<script src="canvas.js"></script>
<script src="main.js"></script>

<!-- ====== Overrides / Mobile enhancements ====== -->
<script>
// ---- Tabs ----
(function(){
  const config = [
    {btn:'#tab-data',  panel:'#panel-data'},
    {btn:'#tab-train', panel:'#panel-train'},
    {btn:'#tab-infer', panel:'#panel-infer'}
  ];
  function selectTab(idx){
    for(let i=0;i<config.length;i++){
      const b = document.querySelector(config[i].btn);
      const p = document.querySelector(config[i].panel);
      if(b){ b.setAttribute('aria-selected', i===idx ? 'true' : 'false'); }
      if(p){ p.hidden = (i!==idx); }
    }
    // 必要なテーブルが無ければ再生成（タブ切替時の初期化用）
    try{ if(typeof window.createTable==='function'){ window.createTable(); } }catch(e){ console.warn(e); }
  }
  // 初期表示
  selectTab(0);
  // クリックハンドラ
  config.forEach((t,idx)=>{
    const b = document.querySelector(t.btn);
    if(b){ b.addEventListener('click', function(){ selectTab(idx); }); }
  });
})();

// ---- Keep legacy #color in sync with #pen_color ----
(function(){
  const pen = document.getElementById('pen_color');
  const legacy = document.getElementById('color');
  function sync(){ legacy.value = pen.value; }
  pen.addEventListener('input', sync);
  sync();
})();

// ---- Canvas: add touch/pointer support + coordinate scaling ----
(function(){
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  let drawing = false, bx=0, by=0;
  function toCanvasXY(e){
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const clientX = (e.touches? e.touches[0].clientX : e.clientX);
    const clientY = (e.touches? e.touches[0].clientY : e.clientY);
    return {x:(clientX - rect.left)*scaleX, y:(clientY - rect.top)*scaleY};
  }
  function pen(){ return document.getElementById('pen_color').value || '#000000'; }
  function drawLine(x,y){
    ctx.lineCap='round';
    ctx.strokeStyle=pen();
    ctx.lineWidth=10;
    ctx.beginPath();
    ctx.moveTo(bx,by);
    ctx.lineTo(x,y);
    ctx.stroke();
    ctx.closePath();
    bx=x; by=y;
  }
  function down(e){ e.preventDefault(); drawing=true; const p=toCanvasXY(e); bx=p.x; by=p.y; }
  function move(e){ if(!drawing) return; e.preventDefault(); const p=toCanvasXY(e); drawLine(p.x,p.y); }
  function up(e){ drawing=false; }

  // Pointer if available
  if(window.PointerEvent){
    canvas.addEventListener('pointerdown', down, {passive:false});
    canvas.addEventListener('pointermove', move, {passive:false});
    canvas.addEventListener('pointerup', up, {passive:false});
    canvas.addEventListener('pointerleave', up, {passive:false});
  } else {
    // Touch + Mouse fallback
    canvas.addEventListener('touchstart', down, {passive:false});
    canvas.addEventListener('touchmove', move, {passive:false});
    canvas.addEventListener('touchend', up, {passive:false});
    canvas.addEventListener('mousedown', down);
    canvas.addEventListener('mousemove', move);
    canvas.addEventListener('mouseup', up);
  }
})();

// ---- Tables generator: split for Data (作成) and Inference (推論) ----
(function(){
  function createDataTable(){
    const table = $('#classes_data');
    if(!table.length) return;
    table.empty();
    for(let i=0;i<target.length;i++){
      const row = $(`
        <tr>
          <td class="radio_button"><input type="radio" name="num" value="${i}" ${i===0?'checked':''}></td>
          <td class="cell cellnum${i}">${target[i]}</td>
          <td class="indicator n${i}">&nbsp;</td>
        </tr>`);
      table.append(row);
    }
  }
  function createPredTable(){
    const table = $('#classes_pred');
    if(!table.length) return;
    table.empty();
    for(let i=0;i<target.length;i++){
      const row = $(`
        <tr>
          <td class="cell cellnum${i}">${target[i]}</td>
          <td class="graph n${i}"></td>
        </tr>`);
      table.append(row);
    }
  }
  window.createTable = function(){
    createDataTable();
    createPredTable();
  };
})();

// ---- Update drawSoftmaxGraph & addCanvasData selectors to new table ----
(function(){
  // keep original functions around if needed
  const _drawSoftmaxGraph = window.drawSoftmaxGraph;
  window.drawSoftmaxGraph = function(h){
    try{
      const s = softmax(h);
      // clear
      $('#classes_pred .graph').html('');
      for(let i=0; i<s.length; i++){
        const px = Math.max(1, Math.floor(s[i]*300));
        const row = $('#classes_pred .graph.n'+i);
        if(row && row.length){ row.html(`<div class="bar" style="width:${px}px"></div>`); }
      }
    }catch(e){ console.warn('drawSoftmaxGraph skipped:', e); }
  };

  const _addCanvasData = window.addCanvasData;
  window.addCanvasData = function(){
    try{
      const num = $('input[name=num]:checked').val();
      const el = $('#classes_data .indicator.n'+num);
      if(el && el.length){
        const t = (el.text()||'') + String.fromCharCode(9609);
        el.text(t);
      }
      // One-hot
      const tvec = []; for(let i=0;i<target.length;i++){ tvec[i]=0; }
      tvec[num] = 1;
      X_batch.push(getCanvasData());
      T_batch.push(tvec);
      clearCanvas();
    }catch(e){ console.warn('addCanvasData skipped:', e); }
  };
})();

// ---- Clear buttons bind (works with original .clear_canvas handler in main.js) ----
(function(){
  $('.clear_canvas').on('click', function(){
    try { clearCanvas(); } catch(e){}
    $('#classes_pred .graph').empty();
  });
})();

// Initialize dynamic table after assets load
$(function(){
  if(typeof createTable === 'function') createTable();
});
</script>

</body>
</html>
