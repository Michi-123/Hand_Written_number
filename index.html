<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Hand written recognition — Mobile + Tabs</title>
<style>
  :root { --gap: 12px; --pad: 12px; }
  html, body { height: 100%; }
  body { background: #f7f7f7; margin: 0; padding: var(--pad); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; color: #222; }

  /* ===== Tabs ===== */
  .tabs { display:flex; gap:8px; margin-bottom: var(--gap); }
  .tabs button { flex: 1 1 0; border:1px solid #bbb; background:#fff; padding:10px 12px; border-radius:10px; font-size:16px; min-height:44px; }
  .tabs button[aria-selected="true"] { background:#222; color:#fff; border-color:#222; }

  /* ===== Layout blocks ===== */
  .toolbar { display:flex; gap:12px; flex-wrap:wrap; margin-bottom: var(--gap); }
  .toolbar .block { background:#eee; padding:8px 10px; border-radius:10px; }

  .canvas-wrap { display:flex; flex-direction:column; gap:8px; align-items:flex-start; }
  canvas { background:#fff; border:1px solid #aaa; border-radius: 8px; width:min(92vw, 360px); height:auto; touch-action:none; }

  .buttons-row { display:flex; flex-wrap:wrap; gap:8px; }
  input[type="button"], input[type="range"], select, input[type="color"], input[type="text"], input[type="number"] { font-size:16px; }
  input[type="button"], .btn { padding:10px 14px; border-radius:8px; border:1px solid #bbb; background:#fff; min-height:44px; }

  /* Panels that existing JS reads by id are kept, we just toggle visibility by body class */
  #label, #graph, #radio, #indicator { background:#fff; border:1px solid #ddd; border-radius:8px; padding:6px; }
  #graph .bar_graph { background-color:#00cc00; height:12px; border-radius:6px; }
  #indicator .ind-pip { display:inline-block; margin-left:4px; }
  .choice-grid { display:grid; grid-template-columns: repeat(5, minmax(40px, 1fr)); gap:8px; }
  @media (max-width: 720px){ .choice-grid{ grid-template-columns: repeat(5, 1fr); } }
  .num-btn { border:1px solid #bbb; border-radius:8px; background:#fff; padding:8px 10px; min-height:44px; font-size:16px; }
  .num-btn.active { background:#222; color:#fff; border-color:#222; }
  table { border-collapse: collapse; }
  td.cell { text-align:center; padding:4px 6px; }

  #predicted{ background:#fff; border:1px solid #ccc; border-radius:8px; display:flex; align-items:center; justify-content:center; width:min(32vw,160px); height:min(32vw,160px); font-size:min(18vw,72px); margin:6px 0; }
  #hypothesis { min-height: 24px; }

  /* ===== Visibility by tab ===== */
  /* Default to 推論 */
  body.tab-infer #canvas-row,
  body.tab-infer #infer-controls,
  body.tab-infer #graph { display:block; }
  body.tab-infer #train-controls,
  body.tab-infer #label,
  body.tab-infer #radio,
  body.tab-infer #type-block,
  body.tab-infer #train-toolbar { display:none; }

  /* データ作成 */
  body.tab-data #canvas-row,
  body.tab-data #label,
  body.tab-data #choice_buttons,
  body.tab-data #indicator,
  body.tab-data #type-block { display:block; }
  body.tab-data #radio { display:none; }
  body.tab-data #infer-controls,
  body.tab-data #graph,
  body.tab-data #train-controls,
  body.tab-data #train-toolbar { display:none; }
  @media (max-width: 720px){ body.tab-data #label { display: table !important; } }

  /* 学習 */
  body.tab-train #train-controls,
  body.tab-train #train-toolbar { display:block; }
  body.tab-train #canvas-row,
  body.tab-train #infer-controls,
  body.tab-train #graph,
  body.tab-train #radio,
  body.tab-train #label,
  body.tab-train #predicted-wrap,
  body.tab-train #type-block { display:none; }

  /* Button-level toggles */
  body.tab-data #add_btn { display:inline-block; }
  body.tab-data #predict { display:none; }
  body.tab-infer #add_btn { display:none; }
  body.tab-infer #predict { display:inline-block; }
  body.tab-train #add_btn,
  body.tab-train #predict { display:none; }

  /* Desktop grid for label/graph when visible */
  .grid { display:grid; grid-template-columns: auto auto; gap:12px; align-items:start; }
  @media (min-width: 921px){ .grid { grid-template-columns: auto auto auto; } }
</style>
</head>
<body class="tab-infer">

<!-- ===== Tab Header ===== -->
<nav class="tabs" role="tablist" aria-label="モード選択">
  <button class="tab-btn" data-tab="data" role="tab" aria-selected="false">データ作成</button>
  <button class="tab-btn" data-tab="train" role="tab" aria-selected="false">学習</button>
  <button class="tab-btn" data-tab="infer" role="tab" aria-selected="true">推論</button>
</nav>

<!-- ===== Shared toolbar (only some parts hidden on certain tabs) ===== -->
<div class="toolbar">
  <div class="block" id="type-block">
    <label for="predict_type" style="display:block;font-size:14px;margin-bottom:4px;">種別</label>
    <select id="predict_type">
      <option value="0">数字</option>
      <option value="1">アルファベット</option>
      <option value="2">かな</option>
      <option value="3">記号</option>
    </select>
  </div>

  <div class="block" id="train-toolbar">
    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
      <label for="learning_rate" style="white-space:nowrap;">学習率</label>
      <input id="learning_rate" value="0.1" inputmode="decimal" />
      <input type="range" id="learning_rate_range" min="0" max="5" />
      <label for="epoch" style="white-space:nowrap; margin-left:12px;">エポック</label>
      <input id="epoch" value="1" inputmode="numeric" />
    </div>
  </div>
</div>

<!-- ===== Canvas Row (visible on データ作成 / 推論) ===== -->
<div id="canvas-row">
  <div class="canvas-wrap">
    <canvas id="canvas" width="280" height="280"></canvas>
    <div class="buttons-row">
      <input type="color" id="color" value="#77cc77" aria-label="ペン色" />
      <input type="button" id="add_btn" value="  Add  " />
      <input type="button" id="predict" value="Predict" />
      <input type="button" id="clear_canvas" value=" Clear " />
    </div>
  </div>

  <div class="grid" style="margin-top:12px;">
    <!-- Label & Radio for データ作成 -->
    <table id="label">
      <tr><td class="cell cellnum0">0</td></tr>
      <tr><td class="cell cellnum1">1</td></tr>
      <tr><td class="cell cellnum2">2</td></tr>
      <tr><td class="cell cellnum3">3</td></tr>
      <tr><td class="cell cellnum4">4</td></tr>
      <tr><td class="cell cellnum5">5</td></tr>
      <tr><td class="cell cellnum6">6</td></tr>
      <tr><td class="cell cellnum7">7</td></tr>
      <tr><td class="cell cellnum8">8</td></tr>
      <tr><td class="cell cellnum9">9</td></tr>
    </table>

    <div id="choice_buttons" class="choice-grid"></div>

    <table id="radio" style="display:none;">
      <tr><td><input type="radio" name="num" value="0" /></td></tr>
      <tr><td><input type="radio" name="num" value="1" /></td></tr>
      <tr><td><input type="radio" name="num" value="2" /></td></tr>
      <tr><td><input type="radio" name="num" value="3" /></td></tr>
      <tr><td><input type="radio" name="num" value="4" /></td></tr>
      <tr><td><input type="radio" name="num" value="5" /></td></tr>
      <tr><td><input type="radio" name="num" value="6" /></td></tr>
      <tr><td><input type="radio" name="num" value="7" /></td></tr>
      <tr><td><input type="radio" name="num" value="8" /></td></tr>
      <tr><td><input type="radio" name="num" value="9" /></td></tr>
    </table>

    <!-- Graph for 推論 -->
    <table id="graph">
      <tr><td class="graph n0"></td></tr>
      <tr><td class="graph n1"></td></tr>
      <tr><td class="graph n2"></td></tr>
      <tr><td class="graph n3"></td></tr>
      <tr><td class="graph n4"></td></tr>
      <tr><td class="graph n5"></td></tr>
      <tr><td class="graph n6"></td></tr>
      <tr><td class="graph n7"></td></tr>
      <tr><td class="graph n8"></td></tr>
      <tr><td class="graph n9"></td></tr>
    </table>
  </div>
</div>

<!-- ===== 推論固有の表示領域 ===== -->
<div id="infer-controls" style="margin-top:8px; display:block;">
  <div id="predicted-wrap" style="display:grid; grid-template-columns: auto 1fr; align-items:center; gap: 8px;">
    <span>Predict:</span>
    <div id="predicted"></div>
    <span>H:</span>
    <span id="hypothesis"> </span>
  </div>
  <span id="hypothesis_all" style="display:none"></span><br />
</div>

<!-- ===== 学習固有の表示領域 ===== -->
<div id="train-controls" style="display:none; margin-top:6px;">
  <div class="buttons-row">
    <input type="button" id="init_weights" value=" Init " />
    <input type="button" id="clear_batch" value="Clr Bat" />
    <input type="button" id="train_btn" value=" Train " />
  </div>
  <div style="margin-top:8px;">loss: <span id="loss"></span></div>
</div>

<form name="form1" style="display:none;"><!-- 互換目的で残す（必要ならJSが参照） --></form>

<!-- ===== (kept) hidden indicator table for JS ===== -->
<table id="indicator" style="display:none;">
  <tr><td class="indicator n0">&nbsp;</td></tr>
  <tr><td class="indicator n1">&nbsp;</td></tr>
  <tr><td class="indicator n2">&nbsp;</td></tr>
  <tr><td class="indicator n3">&nbsp;</td></tr>
  <tr><td class="indicator n4">&nbsp;</td></tr>
  <tr><td class="indicator n5">&nbsp;</td></tr>
  <tr><td class="indicator n6">&nbsp;</td></tr>
  <tr><td class="indicator n7">&nbsp;</td></tr>
  <tr><td class="indicator n8">&nbsp;</td></tr>
  <tr><td class="indicator n9">&nbsp;</td></tr>
</table>

<!-- ===== Scripts ===== -->
<script src="canvas.js"></script>
<script src="jquery.js"></script>
<script src="data/cW1.js"></script>
<script src="data/cW2.js"></script>
<script src="data/cb1.js"></script>
<script src="data/cb2.js"></script>
<script src="data/W1.js"></script>
<script src="data/b1.js"></script>
<script src="data/W2.js"></script>
<script src="data/b2.js"></script>
<script src="network.js"></script>
<script src="main.js"></script>

<script>
  // ===== Tabs behavior =====
  (function(){
    const buttons = document.querySelectorAll('.tab-btn');
    function setTab(name){
      document.body.classList.remove('tab-data','tab-train','tab-infer');
      document.body.classList.add('tab-'+name);
      buttons.forEach(b => b.setAttribute('aria-selected', String(b.dataset.tab===name)));
      // Dataタブに入ったときに、オリジナルの挙動どおり
      // 種別に応じて #label / #radio / #indicator を再構築
      if (name === 'data' && typeof changeLabel === 'function') {
        try { changeLabel(); } catch (e) { console.warn(e); }
      }
    }
    buttons.forEach(btn => btn.addEventListener('click', () => setTab(btn.dataset.tab)));
    setTab('infer'); // default
  })();

  // ===== Data tab: build CHOICE BUTTONS (with hidden radios for compatibility) =====
  (function(){
    const labelTable = document.getElementById('label');
    const radioTable  = document.getElementById('radio'); // hidden, used by existing JS
    const indicatorTable = document.getElementById('indicator');
    const predictType = document.getElementById('predict_type');
    const addBtn = document.getElementById('add_btn');
    const choiceWrap = document.getElementById('choice_buttons');

    function selectIndex(idx){
      // Update hidden radios
      const radios = radioTable.querySelectorAll('input[name="num"]');
      radios.forEach((r,i)=>{ r.checked = (i === idx); });
      // Update visible buttons
      choiceWrap.querySelectorAll('.num-btn').forEach(btn=>btn.classList.remove('active'));
      const activeBtn = choiceWrap.querySelector('.num-btn[data-idx="'+idx+'"]');
      if (activeBtn) activeBtn.classList.add('active');
    }

    function buildHiddenRadios(count){
      radioTable.innerHTML = '';
      for (let i=0;i<count;i++){
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        const input = document.createElement('input');
        input.type = 'radio'; input.name = 'num'; input.value = String(i);
        input.style.display = 'none';
        td.appendChild(input); tr.appendChild(td); radioTable.appendChild(tr);
      }
    }

    function buildButtonsFromLabel(){
      if (!labelTable || !choiceWrap || !radioTable) return;
      const cells = Array.from(labelTable.querySelectorAll('.cell'));
      const prev = radioTable.querySelector('input[name="num"]:checked')?.value ?? null;
      const count = cells.length;
      buildHiddenRadios(count);

      choiceWrap.innerHTML = '';
      cells.forEach((cell, idx) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'num-btn';
        btn.dataset.idx = String(idx);
        btn.textContent = (cell.textContent || String(idx)).trim();
        btn.addEventListener('click', ()=> selectIndex(idx));
        choiceWrap.appendChild(btn);
      });

      // Clicking label rows also selects
      cells.forEach((cell, idx)=>{
        if (cell && cell.parentElement) {
          cell.style.cursor = 'pointer';
          cell.parentElement.addEventListener('click', ()=> selectIndex(idx));
        }
      });

      // Default selection
      const initial = (prev !== null ? Number(prev) : 0);
      selectIndex(Math.min(initial, count-1));
    }

    function refreshDataTab(){
      if (typeof changeLabel === 'function') { try { changeLabel(); } catch(e){} }
      buildButtonsFromLabel();
    }

    if (document.body.classList.contains('tab-data')) refreshDataTab();

    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{ if (btn.dataset.tab === 'data') setTimeout(refreshDataTab,0); });
    });
    if (predictType) predictType.addEventListener('change', refreshDataTab);

    // Indicator mark on Add
    function markIndicator(){
      const sel = radioTable.querySelector('input[name="num"]:checked');
      if (!sel || !indicatorTable) return;
      const idx = sel.value;
      const cell = indicatorTable.querySelector('.n'+idx);
      if (!cell) return;
      const pip = document.createElement('span');
      pip.className = 'ind-pip';
      pip.textContent = '▉';
      cell.appendChild(pip);
    }
    if (addBtn) addBtn.addEventListener('click', markIndicator);

  })();

  // ===== Mobile drawing support (touch events) =====
  (function(){
    const cvs = document.getElementById('canvas');
    if (!cvs) return;

    const toMouseLikeEvent = (e) => {
      const t = e.touches && e.touches[0] ? e.touches[0] : (e.changedTouches ? e.changedTouches[0] : e);
      return { clientX: t.clientX, clientY: t.clientY, target: cvs };
    };

    cvs.addEventListener('touchstart', function(e){
      e.preventDefault();
      window.drawing = true;
      const p = toMouseLikeEvent(e);
      const rect = p.target.getBoundingClientRect();
      window.before_x = p.clientX - rect.left;
      window.before_y = p.clientY - rect.top;
    }, { passive: false });

    cvs.addEventListener('touchmove', function(e){
      e.preventDefault();
      if (!window.drawing) return;
      const p = toMouseLikeEvent(e);
      if (typeof draw_canvas === 'function') draw_canvas(p);
    }, { passive: false });

    cvs.addEventListener('touchend', function(e){
      e.preventDefault();
      window.drawing = false;
    }, { passive: false });
  })();
</script>
</body>
</html>
